<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Bridge Test Application</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="datetime-local"], textarea, input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background-color: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        .file-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .example-format {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #007bff;
        }
        .navigation {
            text-align: center;
            margin-bottom: 20px;
        }
        .navigation a {
            color: #007bff;
            text-decoration: none;
            padding: 10px 20px;
            margin: 0 10px;
            border: 2px solid #007bff;
            border-radius: 5px;
            display: inline-block;
        }
        .navigation a:hover {
            background-color: #007bff;
            color: white;
        }
        .tabs {
            display: flex;
            background-color: #f8f9fa;
            border-radius: 5px 5px 0 0;
            margin-bottom: 0;
            border: 1px solid #ddd;
            border-bottom: none;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-right: 1px solid #ddd;
            background-color: #f8f9fa;
            color: #666;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .tab:last-child {
            border-right: none;
        }
        .tab.active {
            background-color: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }
        .tab:hover {
            background-color: #e9ecef;
        }
        .tab-content {
            display: none;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        .tab-content.active {
            display: block;
        }
        .tab-description {
            background-color: #e7f3ff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            font-style: italic;
            color: #004085;
        }
        code {
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }
        .timestamp-note {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>📱 SMS Bridge Test Application</h1>
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Tab Navigation -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('sms-testing')">📤 SMS Testing</div>
        <div class="tab" onclick="switchTab('mobile-onboarding')">📱 Mobile Onboarding</div>
    </div>

    <!-- SMS Testing Tab -->
    <div id="sms-testing" class="tab-content active">
        <div class="container">
            <div class="tab-description">
                <strong>SMS Testing:</strong> Test portal from localhost to test checks. Laptop Friendly.
            </div>

            <!-- Single SMS Form -->
            <div class="container">
                <h2>📤 Send Single SMS</h2>
        <form action="/send_single" method="POST">
            <div class="form-group">
                <label for="sender_number">Sender Number:</label>
                <input type="text" id="sender_number" name="sender_number" placeholder="+1234567890" required>
            </div>
            
            <div class="form-group">
                <label for="sms_message">SMS Message:</label>
                <textarea id="sms_message" name="sms_message" placeholder="Enter your test SMS message with mobile 9876543210" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="received_timestamp">Received Timestamp:</label>
                <input type="datetime-local" id="received_timestamp" name="received_timestamp" required>
                <div class="timestamp-note">
                    Set to current time: <button type="button" onclick="setCurrentTime()">Set Now</button>
                </div>
            </div>
            
            <button type="submit">Send SMS</button>
        </form>
    </div>
    
    <!-- File Upload Form -->
    <div class="container">
        <h2>📂 Upload Excel/CSV File</h2>
        <form action="/upload_file" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="file">Choose File:</label>
                <input type="file" id="file" name="file" accept=".xlsx,.xls,.csv" required>
            </div>
            
            <button type="submit">Upload and Process</button>
        </form>
        
        <div class="file-info">
            <h3>📋 File Format Requirements:</h3>
            <p>Your Excel/CSV file must contain the following columns:</p>
            <ul>
                <li><code>sender_number</code> - Phone number (e.g., +1234567890)</li>
                <li><code>sms_message</code> - SMS content (e.g., "Test message from mobile 9876543210")</li>
                <li><code>received_timestamp</code> - ISO timestamp (e.g., 2025-09-07T12:00:00Z)</li>
            </ul>
        </div>
        
        <div class="example-format">
            <h4>Example Excel/CSV Format:</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="background-color: #e9ecef;">
                    <th style="border: 1px solid #ddd; padding: 8px;">sender_number</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">sms_message</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">received_timestamp</th>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">+1234567890</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">Test message 1 from mobile 9876543210</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">2025-09-07T12:00:00Z</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">+1234567891</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">Test message 2 from mobile 9876543211</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">2025-09-07T12:01:00Z</td>
                </tr>
            </table>
        </div>
    </div>
    
    <!-- API Documentation -->
    <div class="container">
        <h2>🔧 API Usage</h2>
        <p>You can also send SMS programmatically using the API endpoint:</p>
        <div class="example-format">
            <h4>POST /api/send_sms</h4>
            <pre><code>curl -X POST http://localhost:3000/api/send_sms \
  -H "Content-Type: application/json" \
  -d '{
    "sender_number": "+1234567890",
    "sms_message": "Test API message from mobile 9876543210",
    "received_timestamp": "2025-09-07T12:00:00Z"
  }'</code></pre>
        </div>
    </div>
        </div>
    </div>

    <!-- Mobile Onboarding Tab -->
    <div id="mobile-onboarding" class="tab-content">
        <div class="container">
            <div class="tab-description">
                <strong>Mobile Onboarding:</strong> End to end test. Mobile Friendly.
            </div>

            <!-- Mobile Registration Form -->
            <div class="container">
                <h2>📱 Register Mobile Number</h2>
                <form method="POST" action="{{ url_for('register_mobile') }}">
                    <div class="form-group">
                        <label for="mobile_number">Mobile Number (10-15 digits):</label>
                        <input type="text" 
                               id="mobile_number" 
                               name="mobile_number" 
                               placeholder="e.g., 9876543210" 
                               pattern="[0-9]{10,15}"
                               required>
                    </div>
                    <button type="submit">Register Mobile</button>
                </form>
                
                {% if mobile_number and hash_value %}
                <div class="result-box" style="background-color: #e7f3ff; padding: 20px; border-radius: 5px; margin-top: 20px; border-left: 4px solid #007bff;">
                    <h3>Registration Successful!</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <tr>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd; background-color: #f8f9fa; font-weight: bold;">Mobile Number:</th>
                            <td style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">{{ mobile_number }}</td>
                        </tr>
                        <tr>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd; background-color: #f8f9fa; font-weight: bold;">SMS to Send:</th>
                            <td style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">
                                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; word-break: break-all; border: 1px solid #dee2e6;">{{ sms_message }}</div>
                                <button style="background-color: #28a745; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; margin-top: 10px; margin-right: 10px;" onclick="copyToClipboard('{{ sms_message }}')">Copy SMS</button>
                                <button style="background-color: #17a2b8; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; margin-top: 10px;" onclick="openSMSApp('{{ sms_message }}')">Send SMS</button>
                            </td>
                        </tr>
                    </table>
                    <p><strong>Instructions:</strong></p>
                    <ol>
                        <li>Use "Send SMS" button to open your mobile SMS app with pre-filled message</li>
                        <li>Or copy the message and paste it manually in your SMS app</li>
                        <li>Send the SMS to test the validation system</li>
                        <li>Check results in the SMS Testing tab or database</li>
                    </ol>
                </div>
                {% endif %}
            </div>

            <!-- Status Check Form -->
            <div class="container">
                <h2>📊 Check Onboarding Status</h2>
                <form method="POST" action="{{ url_for('check_onboarding_status') }}">
                    <div class="form-group">
                        <label for="status_mobile_number">Mobile Number:</label>
                        <input type="text" 
                               id="status_mobile_number" 
                               name="mobile_number" 
                               placeholder="e.g., 9876543210" 
                               pattern="[0-9]{10,15}"
                               required>
                    </div>
                    <button type="submit" style="background-color: #6c757d;">Check Status</button>
                </form>
                
                {% if status_mobile and status_data %}
                <div style="background-color: #e7f3ff; padding: 20px; border-radius: 5px; margin-top: 20px; border-left: 4px solid #007bff;">
                    <h3>Onboarding Status for {{ status_mobile }}</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <tr>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd; background-color: #f8f9fa; font-weight: bold;">Mobile Number:</th>
                            <td style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">{{ status_data.mobile_number }}</td>
                        </tr>
                        <tr>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd; background-color: #f8f9fa; font-weight: bold;">Registration Time:</th>
                            <td style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">{{ status_data.request_timestamp }}</td>
                        </tr>
                        <tr>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd; background-color: #f8f9fa; font-weight: bold;">Status:</th>
                            <td style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; {% if status_data.is_active %}background-color: #d4edda; color: #155724;{% else %}background-color: #f8d7da; color: #721c24;{% endif %}">
                                    {% if status_data.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd; background-color: #f8f9fa; font-weight: bold;">SMS Validated:</th>
                            <td style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; {% if status_data.sms_validated %}background-color: #cce7ff; color: #004085;{% else %}background-color: #f8d7da; color: #721c24;{% endif %}">
                                    {% if status_data.sms_validated %}Yes{% else %}No{% endif %}
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>
                {% endif %}
            </div>

            <!-- Instructions -->
            <div class="container">
                <h2>ℹ️ How It Works</h2>
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 5px;">
                    <h4>Onboarding Process:</h4>
                    <ol>
                        <li><strong>Register:</strong> Enter your mobile number to generate a unique hash</li>
                        <li><strong>Get SMS Format:</strong> System provides the exact SMS message to send</li>
                        <li><strong>Send SMS:</strong> Use the "Send SMS" button or SMS Testing tab</li>
                        <li><strong>Validation:</strong> System validates the SMS against your onboarding record</li>
                        <li><strong>Check Status:</strong> Monitor your onboarding and validation status</li>
                    </ol>
                    
                    <h4>SMS Format:</h4>
                    <p>The generated SMS follows this format:</p>
                    <code>ONBOARD:HASH</code>
                    <p>Example: <code>ONBOARD:a1b2c3d4e5f6...</code></p>
                    
                    <h4>Validation Checks:</h4>
                    <ul>
                        <li><strong>Foreign Number:</strong> Validates country code</li>
                        <li><strong>Mobile Check:</strong> Verifies mobile exists in onboarding system</li>
                        <li><strong>Header Hash:</strong> Validates message format and hash integrity</li>
                        <li><strong>Time Window:</strong> Ensures SMS sent within allowed timeframe</li>
                        <li><strong>Other checks:</strong> Blacklist, duplicate detection, etc.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        function setCurrentTime() {
            const now = new Date();
            const localDateTime = now.toISOString().slice(0, 16);
            document.getElementById('received_timestamp').value = localDateTime;
        }
        
        function switchTab(tabName) {
            // Hide all tab contents
            var contents = document.getElementsByClassName('tab-content');
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            
            // Remove active class from all tabs
            var tabs = document.getElementsByClassName('tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('SMS message copied to clipboard!');
            }, function(err) {
                console.error('Could not copy text: ', err);
                // Fallback for older browsers
                var textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('SMS message copied to clipboard!');
                } catch (err) {
                    alert('Failed to copy. Please copy manually.');
                }
                document.body.removeChild(textArea);
            });
        }
        
        function openSMSApp(message) {
            // For mobile devices, try to open SMS app with pre-filled message
            var smsUrl = 'sms:?body=' + encodeURIComponent(message);
            
            // Try to open SMS app
            var link = document.createElement('a');
            link.href = smsUrl;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Fallback: copy to clipboard if SMS app doesn't open
            setTimeout(function() {
                copyToClipboard(message);
            }, 1000);
        }
        
        // Set current time on page load
        window.onload = function() {
            setCurrentTime();
        }
    </script>
</body>
</html>
